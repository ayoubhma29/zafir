<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZAFIR - Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Cairo', sans-serif; background-color: #f8fafc; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .loader { border: 3px solid #f3f3f3; border-radius: 50%; border-top: 3px solid #f97316; width: 24px; height: 24px; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* Status Colors */
        select.status-New { background-color: #e2e8f0; color: #475569; border-color: #cbd5e1; }
        select.status-NoAnswer1 { background-color: #fef9c3; color: #854d0e; border-color: #fde047; }
        select.status-NoAnswer2 { background-color: #fef08a; color: #854d0e; border-color: #facc15; }
        select.status-NoAnswer3 { background-color: #fde047; color: #854d0e; border-color: #eab308; }
        select.status-Confirmed { background-color: #dcfce7; color: #166534; border-color: #86efac; }
        select.status-Postponed { background-color: #ffedd5; color: #9a3412; border-color: #fdba74; }
        select.status-Cancelled { background-color: #fee2e2; color: #991b1b; border-color: #fca5a5; }
        select.status-Fake { background-color: #1e293b; color: #cbd5e1; border-color: #475569; }
    </style>
</head>
<body class="text-gray-800">

    <div id="loginSection" class="fixed inset-0 bg-slate-900 bg-opacity-95 flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="bg-white p-8 rounded-2xl shadow-2xl text-center w-96 border border-gray-100">
            <div class="text-4xl mb-4">ğŸ”</div>
            <h2 class="text-2xl font-black mb-6 text-slate-800">Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø¯ÙŠØ±</h2>
            <input type="password" id="adminPass" class="w-full p-3 border border-gray-300 rounded-xl mb-4 focus:outline-none focus:border-orange-500 transition text-center text-lg" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
            <button onclick="checkLogin()" class="w-full bg-gradient-to-r from-orange-500 to-orange-600 text-white p-3 rounded-xl font-bold hover:shadow-lg transform active:scale-95 transition">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
        </div>
    </div>

    <div id="dashboardContent" class="hidden min-h-screen">
        <nav class="bg-white shadow-md sticky top-0 z-40 border-b border-gray-100">
            <div class="container mx-auto px-4 py-3 flex justify-between items-center">
                <div class="text-xl md:text-2xl font-black text-slate-800 tracking-tight">ZAFIR<span class="text-orange-500">.</span> SHOP</div>
                <div class="flex gap-2">
                    <button onclick="refreshData()" class="bg-slate-100 text-slate-600 px-4 py-2 rounded-lg hover:bg-slate-200 text-sm font-bold flex items-center gap-2 transition"><span>ğŸ”„</span> <span class="hidden md:inline">ØªØ­Ø¯ÙŠØ«</span></button>
                    <button onclick="exportToCSV()" class="bg-green-100 text-green-700 px-4 py-2 rounded-lg hover:bg-green-200 text-sm font-bold flex items-center gap-2 transition"><span>ğŸ“¥</span> <span class="hidden md:inline">Excel</span></button>
                </div>
            </div>
        </nav>

        <div class="container mx-auto px-2 md:px-4 py-6 pb-20">
            <div class="grid grid-cols-2 md:grid-cols-4 gap-3 md:gap-4 mb-6">
                <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 relative overflow-hidden group">
                    <div class="absolute right-0 top-0 p-3 opacity-10 group-hover:opacity-20 transition text-4xl">ğŸ“¦</div>
                    <p class="text-slate-500 text-xs font-bold mb-1">Ø§Ù„ÙƒÙ„</p>
                    <p class="text-2xl font-black text-slate-800" id="totalOrders">0</p>
                </div>
                <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 relative overflow-hidden group">
                    <div class="absolute right-0 top-0 p-3 opacity-10 group-hover:opacity-20 transition text-4xl">ğŸ’°</div>
                    <p class="text-slate-500 text-xs font-bold mb-1">Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹Ø©</p>
                    <p class="text-2xl font-black text-green-600" id="totalRevenue">0 <span class="text-xs text-slate-400">DH</span></p>
                </div>
                <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 relative overflow-hidden group">
                    <div class="absolute right-0 top-0 p-3 opacity-10 group-hover:opacity-20 transition text-4xl">ğŸ”¥</div>
                    <p class="text-slate-500 text-xs font-bold mb-1">Ø¬Ø¯ÙŠØ¯ Ø§Ù„ÙŠÙˆÙ…</p>
                    <p class="text-2xl font-black text-orange-500" id="newOrdersCount">0</p>
                </div>
                <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 relative overflow-hidden group">
                    <div class="absolute right-0 top-0 p-3 opacity-10 group-hover:opacity-20 transition text-4xl">âœ…</div>
                    <p class="text-slate-500 text-xs font-bold mb-1">Ù†Ø³Ø¨Ø© Ø§Ù„ØªØ£ÙƒÙŠØ¯</p>
                    <p class="text-2xl font-black text-blue-600" id="conversionRate">0%</p>
                </div>
            </div>

            <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100 mb-4 flex flex-col md:flex-row gap-3 justify-between items-center">
                <h3 class="font-bold text-slate-700 w-full md:w-auto">ğŸ“‹ Ù„Ø§Ø¦Ø­Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h3>
                <input type="text" id="searchInput" onkeyup="filterTable()" placeholder="ğŸ” Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…ØŒ Ø§Ù„Ù‡Ø§ØªÙ Ø£Ùˆ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©..." class="w-full md:w-1/3 p-2 bg-slate-50 border border-slate-200 rounded-lg text-sm focus:outline-none focus:border-orange-400">
            </div>

            <div class="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-right text-sm whitespace-nowrap">
                        <thead class="bg-slate-50 text-slate-600 border-b border-slate-200">
                            <tr>
                                <th class="p-4 text-xs font-extrabold uppercase">#ID</th>
                                <th class="p-4 text-xs font-extrabold uppercase">Ø§Ù„Ø­Ø§Ù„Ø© (Action)</th>
                                <th class="p-4 text-xs font-extrabold uppercase">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø²Ø¨ÙˆÙ†</th>
                                <th class="p-4 text-xs font-extrabold uppercase">Ø§Ù„Ù…Ù†ØªØ¬ ÙˆØ§Ù„Ø³Ø¹Ø±</th>
                                <th class="p-4 text-xs font-extrabold uppercase">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                <th class="p-4 text-xs font-extrabold uppercase text-center">Ø§ØªØµØ§Ù„</th>
                            </tr>
                        </thead>
                        <tbody id="ordersTableBody" class="divide-y divide-slate-100"></tbody>
                    </table>
                    <div id="loadingIndicator" class="p-10 text-center w-full">
                        <div class="loader"></div>
                        <p class="text-slate-400 mt-3 text-xs font-bold">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</p>
                    </div>
                    <div id="emptyState" class="hidden p-10 text-center w-full">
                        <div class="text-4xl mb-2">ğŸ“­</div>
                        <p class="text-slate-400 text-sm">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ (ÙƒÙ…Ø§ ÙÙŠ Ø§Ù„ØµÙˆØ±Ø©)
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbylRACNSa-zj73gjancTwVUg5qGeeHIH1YRdYJL2TXvoBAf9WjzcWl_APOz8QZA62iO/exec";
        
        // ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±
        const ADMIN_PASS = "2911"; 

        const STATUS_OPTIONS = [
            { value: "New", label: "âœ¨ Ø¬Ø¯ÙŠØ¯", class: "status-New" },
            { value: "NoAnswer1", label: "ğŸ“ Ù„Ø§ ÙŠØ¬ÙŠØ¨ (1)", class: "status-NoAnswer1" },
            { value: "NoAnswer2", label: "ğŸ“ Ù„Ø§ ÙŠØ¬ÙŠØ¨ (2)", class: "status-NoAnswer2" },
            { value: "NoAnswer3", label: "ğŸ“ Ù„Ø§ ÙŠØ¬ÙŠØ¨ (3)", class: "status-NoAnswer3" },
            { value: "Postponed", label: "â³ Ù…Ø¤Ø¬Ù„", class: "status-Postponed" },
            { value: "Confirmed", label: "âœ… ØªÙ… Ø§Ù„ØªØ£ÙƒÙŠØ¯", class: "status-Confirmed" },
            { value: "Cancelled", label: "âŒ Ù…Ù„ØºÙŠ", class: "status-Cancelled" },
            { value: "Fake", label: "ğŸš« ÙˆÙ‡Ù…ÙŠ/Ø³Ø¨Ø§Ù…", class: "status-Fake" }
        ];

        function checkLogin() {
            const input = document.getElementById('adminPass').value;
            if(input === ADMIN_PASS) {
                document.getElementById('loginSection').style.display = 'none';
                document.getElementById('dashboardContent').style.display = 'block';
                fetchData();
            } else {
                alert("ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø®Ø§Ø·Ø¦Ø©!");
                document.getElementById('adminPass').value = '';
            }
        }

        let allOrders = [];

        async function fetchData() {
            const loader = document.getElementById('loadingIndicator');
            const tbody = document.getElementById('ordersTableBody');
            const empty = document.getElementById('emptyState');
            
            loader.style.display = 'block';
            tbody.innerHTML = '';
            empty.style.display = 'none';
            
            try {
                const response = await fetch(`${SCRIPT_URL}?action=read`);
                const data = await response.json();
                allOrders = data.reverse(); 
                
                if (allOrders.length === 0) {
                    empty.style.display = 'block';
                } else {
                    renderTable(allOrders);
                }
                
                calculateStats(allOrders);
                loader.style.display = 'none';

            } catch (error) {
                console.error("Error:", error);
                // Ù‡Ø°Ø§ Ø§Ù„Ø®Ø·Ø£ Ù‡Ùˆ Ø§Ù„Ø°ÙŠ ÙƒØ§Ù† ÙŠØ¸Ù‡Ø± Ù„Ùƒ Ø³Ø§Ø¨Ù‚Ø§Ù‹ØŒ Ø§Ù„Ø¢Ù† Ø³ÙŠØ¹Ù…Ù„
                alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Google Sheet Ù„ÙŠØ³ ÙØ§Ø±ØºØ§Ù‹ ØªÙ…Ø§Ù…Ø§Ù‹.");
                loader.style.display = 'none';
            }
        }

        function renderTable(orders) {
            const tbody = document.getElementById('ordersTableBody');
            tbody.innerHTML = '';

            orders.forEach(order => {
                // --- FIX: ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù‡Ø§ØªÙ Ø¥Ù„Ù‰ Ù†Øµ Ù„ØªØ¬Ù†Ø¨ Ø§Ù„Ù…Ø´ÙƒÙ„Ø© ---
                let phoneStr = String(order.phone); 
                let whatsappLink = "https://wa.me/212" + phoneStr.substring(1); 
                
                // Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® (Ù‚Ø¯ ØªÙƒÙˆÙ† Ù†ØµØ§Ù‹ Ø£Ùˆ ÙƒØ§Ø¦Ù†Ø§Ù‹)
                let dateDisplay = order.date;
                try {
                   let dateObj = new Date(order.date);
                   if(!isNaN(dateObj)) {
                       dateDisplay = dateObj.toLocaleDateString('en-GB') + ' <span class="text-slate-400 text-xs">' + dateObj.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) + '</span>';
                   }
                } catch(e) {}

                let rowBg = "";
                if (order.status === 'Confirmed') rowBg = "bg-green-50/50";
                if (order.status === 'Cancelled') rowBg = "bg-red-50/50";
                if (order.status === 'Fake') rowBg = "bg-slate-100 opacity-60";

                let optionsHTML = '';
                STATUS_OPTIONS.forEach(opt => {
                    const selected = order.status === opt.value ? 'selected' : '';
                    optionsHTML += `<option value="${opt.value}" ${selected}>${opt.label}</option>`;
                });

                const currentStatusObj = STATUS_OPTIONS.find(s => s.value === order.status) || STATUS_OPTIONS[0];
                const selectClass = currentStatusObj.class;

                const row = `
                    <tr class="border-b border-slate-50 hover:bg-slate-50 transition ${rowBg}">
                        <td class="p-4 font-mono text-slate-400 font-bold">#${order.order_id}</td>
                        <td class="p-4">
                            <div class="relative">
                                <select onchange="updateStatus(${order.row_index}, this)" class="appearance-none w-36 px-3 py-2 rounded-lg text-xs font-bold border-2 focus:outline-none cursor-pointer ${selectClass}">
                                    ${optionsHTML}
                                </select>
                                <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center px-2 text-gray-500 text-xs">â–¼</div>
                            </div>
                        </td>
                        <td class="p-4">
                            <div class="font-bold text-slate-800">${order.name}</div>
                            <div class="text-xs text-slate-500 font-mono tracking-wider mt-1">${phoneStr}</div>
                            <div class="text-xs text-slate-400 mt-1">ğŸ“ ${order.city}</div>
                            ${order.address && order.address !== 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' ? `<div class="text-[10px] text-slate-400 truncate max-w-[150px]">${order.address}</div>` : ''}
                        </td>
                        <td class="p-4">
                            <div class="font-bold text-slate-700 text-xs">${order.product}</div>
                            <div class="text-orange-600 font-black mt-1">${order.price} DH</div>
                        </td>
                        <td class="p-4 text-sm text-slate-600">${dateDisplay}</td>
                        <td class="p-4 text-center">
                            <a href="${whatsappLink}?text=Ø§Ù„Ø³Ù„Ø§Ù… Ø¹Ù„ÙŠÙƒÙ… ${order.name}ØŒ Ù…Ø¹Ø§Ùƒ Ø®Ø¯Ù…Ø© Ø§Ù„ØªÙˆØµÙŠÙ„ Ø¨Ø®ØµÙˆØµ Ø·Ù„Ø¨Ùƒ Ù„Ù€ ${order.product}..." target="_blank" class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-green-100 text-green-600 hover:bg-green-500 hover:text-white transition shadow-sm" title="Ù…Ø±Ø§Ø³Ù„Ø© ÙˆØ§ØªØ³Ø§Ø¨">
                                <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M13.601 2.326A7.854 7.854 0 0 0 7.994 0C3.627 0 .068 3.558.064 7.926c0 1.399.366 2.76 1.057 3.965L0 16l4.204-1.102a7.933 7.933 0 0 0 3.79.965h.004c4.368 0 7.926-3.558 7.93-7.93A7.898 7.898 0 0 0 13.6 2.326zM7.994 14.521a6.573 6.573 0 0 1-3.356-.92l-.24-.144-2.494.654.666-2.433-.156-.251a6.56 6.56 0 0 1-1.007-3.505c0-3.626 2.957-6.584 6.591-6.584a6.56 6.56 0 0 1 4.66 1.931 6.557 6.557 0 0 1 1.928 4.66c-.004 3.639-2.961 6.592-6.592 6.592z"/></svg>
                            </a>
                            <a href="tel:${phoneStr}" class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-blue-100 text-blue-600 hover:bg-blue-500 hover:text-white transition shadow-sm mr-2" title="Ø§ØªØµØ§Ù„">
                               <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M3.654 1.328a.678.678 0 0 0-1.015-.063L1.605 2.3c-.483.484-.661 1.169-.45 1.77a17.568 17.568 0 0 0 4.168 6.608 17.569 17.569 0 0 0 6.608 4.168c.601.211 1.286.033 1.77-.45l1.034-1.034a.678.678 0 0 0-.063-1.015l-2.307-1.794a.678.678 0 0 0-.58-.122l-2.19.547a1.745 1.745 0 0 1-1.657-.459L5.482 8.062a1.745 1.745 0 0 1-.46-1.657l.548-2.19a.678.678 0 0 0-.122-.58L3.654 1.328zM1.884.511a1.745 1.745 0 0 1 2.612.163L6.29 2.98c.329.423.445.974.315 1.494l-.547 2.19a.678.678 0 0 0 .178.643l2.457 2.457a.678.678 0 0 0 .644.178l2.189-.547a1.745 1.745 0 0 1 1.494.315l2.306 1.794c.829.645.905 1.87.163 2.611l-1.034 1.034c-.74.74-1.846 1.065-2.877.702a18.634 18.634 0 0 1-7.01-4.42 18.634 18.634 0 0 1-4.42-7.009c-.362-1.03-.037-2.137.703-2.877L1.885.511z"/></svg>
                            </a>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        async function updateStatus(rowIndex, selectElement) {
            const newStatus = selectElement.value;
            const statusObj = STATUS_OPTIONS.find(s => s.value === newStatus);
            selectElement.className = `appearance-none w-36 px-3 py-2 rounded-lg text-xs font-bold border-2 focus:outline-none cursor-pointer ${statusObj.class}`;

            try {
                const formData = new FormData();
                formData.append('action', 'update');
                formData.append('row_index', rowIndex);
                formData.append('status', newStatus);

                await fetch(SCRIPT_URL, { method: 'POST', body: formData, mode: 'no-cors' });
                
                setTimeout(() => {
                    const order = allOrders.find(o => o.row_index === rowIndex);
                    if(order) order.status = newStatus;
                    calculateStats(allOrders);
                }, 500);

            } catch (error) {
                console.error("Update failed", error);
            }
        }

        function calculateStats(orders) {
            document.getElementById('totalOrders').innerText = orders.length;
            const revenue = orders.reduce((sum, order) => {
                const isValid = !['Cancelled', 'Fake'].includes(order.status);
                return isValid ? sum + parseFloat(order.price) : sum;
            }, 0);
            document.getElementById('totalRevenue').innerText = revenue.toLocaleString();

            const newOrders = orders.filter(o => o.status === 'New').length;
            document.getElementById('newOrdersCount').innerText = newOrders;

            const confirmedCount = orders.filter(o => o.status === 'Confirmed').length;
            const validTotal = orders.filter(o => o.status !== 'Fake').length; 
            const rate = validTotal > 0 ? Math.round((confirmedCount / validTotal) * 100) : 0;
            document.getElementById('conversionRate').innerText = rate + "%";
        }

        function filterTable() {
            const input = document.getElementById("searchInput");
            const filter = input.value.toUpperCase();
            const table = document.getElementById("ordersTableBody");
            const tr = table.getElementsByTagName("tr");
            for (let i = 0; i < tr.length; i++) {
                const tdName = tr[i].getElementsByTagName("td")[2]; 
                const tdID = tr[i].getElementsByTagName("td")[0];
                if (tdName || tdID) {
                    const txtValue = tdName.textContent || tdName.innerText;
                    const idValue = tdID.textContent || tdID.innerText;
                    if (txtValue.toUpperCase().indexOf(filter) > -1 || idValue.toUpperCase().indexOf(filter) > -1) {
                        tr[i].style.display = "";
                    } else {
                        tr[i].style.display = "none";
                    }
                }
            }
        }
        function refreshData() { fetchData(); }
        function exportToCSV() {
            let csvContent = "data:text/csv;charset=utf-8,\uFEFF";
            csvContent += "ID,Name,Phone,City,Address,Product,Price,Date,Status\n";
            allOrders.forEach(function(row) {
                let rowData = `${row.order_id},"${row.name}","'${row.phone}","${row.city}","${row.address}","${row.product}",${row.price},"${row.date}","${row.status}"`;
                csvContent += rowData + "\n";
            });
            var encodedUri = encodeURI(csvContent);
            var link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "zafir_orders.csv");
            document.body.appendChild(link);
            link.click();
        }
    </script>
</body>
</html>

