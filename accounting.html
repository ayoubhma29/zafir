<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ZAFIR Accounting Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Cairo', 'sans-serif'] },
                    colors: {
                        primary: '#0f172a',
                        accent: '#f97316',
                    },
                    boxShadow: {
                        'soft': '0 4px 20px -2px rgba(0, 0, 0, 0.05)',
                        'glow': '0 0 15px rgba(249, 115, 22, 0.3)'
                    }
                }
            }
        }
    </script>

    <style>
        body { background-color: #f8fafc; -webkit-tap-highlight-color: transparent; }
        .glass { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(12px); border-bottom: 1px solid rgba(226, 232, 240, 0.8); }
        ::-webkit-scrollbar { width: 5px; height: 5px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; transition: all 0.3s; }
        .st-loading { background: #3b82f6; box-shadow: 0 0 8px #3b82f6; animation: pulse 1s infinite; }
        .st-saved { background: #22c55e; box-shadow: 0 0 8px #22c55e; }
        .st-error { background: #ef4444; box-shadow: 0 0 8px #ef4444; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        .fade-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="text-slate-800 pb-20 relative min-h-screen selection:bg-orange-100 selection:text-orange-900">

    <div id="toast-container" class="fixed bottom-10 left-1/2 transform -translate-x-1/2 z-[100] flex flex-col gap-2 pointer-events-none w-full max-w-xs px-4"></div>

    <div id="loginSection" class="fixed inset-0 bg-slate-900 z-[60] flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm p-8 rounded-3xl shadow-2xl text-center border border-slate-700 relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-orange-400 to-orange-600"></div>
            <div class="w-20 h-20 bg-orange-50 rounded-full flex items-center justify-center mx-auto mb-6 text-4xl shadow-sm border border-orange-100">ğŸ“Š</div>
            <h2 class="text-2xl font-black text-slate-800 mb-2">Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø§Ù„ÙŠ</h2>
            <form onsubmit="event.preventDefault(); attemptLogin();">
                <input type="password" id="adminPass" class="w-full p-4 bg-slate-50 border border-slate-200 rounded-2xl text-center text-lg font-bold focus:outline-none focus:border-orange-500 focus:ring-4 focus:ring-orange-500/10 mb-4 transition-all" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø³Ø±ÙŠ">
                <button type="submit" class="w-full bg-slate-900 text-white p-4 rounded-2xl font-bold hover:bg-orange-600 transition shadow-lg active:scale-95 flex justify-center items-center gap-2"><span>Ø¯Ø®ÙˆÙ„</span></button>
            </form>
        </div>
    </div>

    <div id="dashboardContent" class="hidden min-h-screen flex flex-col">
        
        <nav class="glass sticky top-0 z-40 transition-all duration-300">
            <div class="container mx-auto px-4 h-16 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <div class="text-xl font-black text-slate-800 tracking-tighter select-none flex items-center gap-1">ZAFIR<span class="text-orange-500 text-3xl leading-3">.</span></div>
                    <div class="status-dot st-loading" id="syncStatus" title="Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©"></div>
                </div>
                <button onclick="logout()" class="p-2 bg-red-50 text-red-600 rounded-xl hover:bg-red-100 transition" title="ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                </button>
            </div>
        </nav>

        <div class="container mx-auto px-4 py-6 flex-1">
            
            <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6">
                <div class="bg-white p-4 rounded-2xl border border-red-100 shadow-sm flex flex-col justify-between hover:-translate-y-1 transition duration-300">
                    <div class="flex justify-between items-start mb-2"><p class="text-[10px] text-red-500 font-bold uppercase">Ø¯ÙŠÙˆÙ† Ø§Ù„Ù…ÙˆØ±Ø¯</p><span class="bg-red-50 text-red-500 p-1 rounded text-xs">ğŸ“‰</span></div>
                    <p class="text-2xl font-black text-red-600" id="supplierDebt">0</p>
                    <p class="text-[10px] text-slate-400 mt-1">Ø³Ù„Ø¹ Ø¬Ø¯ÙŠØ¯Ø© + ØªØºÙ„ÙŠÙ</p>
                </div>
                <div class="bg-white p-4 rounded-2xl border border-orange-100 shadow-sm flex flex-col justify-between hover:-translate-y-1 transition duration-300">
                    <div class="flex justify-between items-start mb-2"><p class="text-[10px] text-orange-500 font-bold uppercase">Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ (Ads)</p><span class="bg-orange-50 text-orange-500 p-1 rounded text-xs">ğŸ“¢</span></div>
                    <p class="text-2xl font-black text-orange-500" id="totalExpenses">0</p>
                </div>
                <div class="bg-white p-4 rounded-2xl border border-emerald-100 shadow-sm flex flex-col justify-between hover:-translate-y-1 transition duration-300">
                    <div class="flex justify-between items-start mb-2"><p class="text-[10px] text-emerald-600 font-bold uppercase">Ø§Ù„Ù…Ø¯Ø®ÙˆÙ„ (Cash)</p><span class="bg-emerald-50 text-emerald-600 p-1 rounded text-xs">ğŸ’µ</span></div>
                    <p class="text-2xl font-black text-emerald-600" id="totalRevenue">0</p>
                </div>
                <div class="bg-slate-900 p-4 rounded-2xl border border-slate-800 shadow-glow flex flex-col justify-between relative overflow-hidden group hover:-translate-y-1 transition duration-300">
                    <div class="absolute -right-2 -top-2 text-white opacity-5 text-7xl font-black">$</div>
                    <div class="flex justify-between items-start z-10 mb-2"><p class="text-[10px] text-slate-300 font-bold uppercase">Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„ØµØ§ÙÙŠ</p><span class="bg-slate-800 text-white p-1 rounded text-xs border border-slate-700">ğŸ’</span></div>
                    <p class="text-2xl font-black text-white z-10" id="netProfit">0</p>
                </div>
            </div>

            <div class="grid lg:grid-cols-3 gap-6">
                
                <div class="lg:col-span-1 space-y-4">
                    <div class="bg-white p-5 rounded-3xl border border-slate-100 shadow-soft h-full flex flex-col fade-in">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-base text-slate-800 flex items-center gap-2"><span class="bg-blue-50 text-blue-600 p-1.5 rounded-lg">ğŸ“¦</span> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h3>
                            <span class="text-[10px] bg-slate-800 text-white px-2 py-0.5 rounded-md font-bold" id="prodCount">0</span>
                        </div>
                        
                        <div class="bg-slate-50 p-3 rounded-2xl border border-slate-200 mb-4">
                            <label class="text-[10px] font-bold text-slate-400 mb-1 block">Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯</label>
                            <div class="space-y-2">
                                <input type="text" id="prodName" class="w-full h-9 px-3 bg-white rounded-xl text-xs font-bold outline-none focus:ring-2 focus:ring-blue-100 transition border border-slate-100" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ (Ù…Ø«Ø§Ù„: Ensemble Lacoste)">
                                <div class="flex gap-2">
                                    <div class="flex-1 relative"><input type="number" id="prodCost" class="w-full h-9 px-2 bg-white rounded-xl text-xs text-center outline-none font-bold border border-slate-100 focus:ring-2 focus:ring-blue-100" placeholder="Ø§Ù„ØªÙƒÙ„ÙØ©"><span class="absolute left-2 top-2.5 text-[8px] text-slate-400 font-bold">DH</span></div>
                                    <div class="flex-1 relative"><input type="number" id="prodPack" class="w-full h-9 px-2 bg-white rounded-xl text-xs text-center outline-none font-bold border border-slate-100 focus:ring-2 focus:ring-blue-100" placeholder="Ø§Ù„ØªØºÙ„ÙŠÙ"><span class="absolute left-2 top-2.5 text-[8px] text-slate-400 font-bold">DH</span></div>
                                    <button onclick="addProduct()" class="bg-slate-900 text-white w-9 h-9 shrink-0 rounded-xl hover:bg-orange-600 transition flex items-center justify-center font-bold text-lg shadow-md active:scale-95">+</button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex-1 flex flex-col min-h-[300px]">
                            <input type="text" id="prodSearch" onkeyup="renderProducts()" class="w-full mb-3 h-9 px-3 bg-white border border-slate-200 rounded-xl text-xs outline-none focus:border-blue-300 transition font-bold text-slate-600" placeholder="ğŸ” Ø¨Ø­Ø«...">
                            <div class="flex justify-between text-[9px] text-slate-400 font-bold uppercase mb-2 px-2"><span>Ø§Ù„Ù…Ù†ØªØ¬ (ØªÙƒÙ„ÙØ© + ØªØºÙ„ÙŠÙ)</span><span>Ù…Ø®Ø²ÙˆÙ† (Stock)</span></div>
                            <div id="productsList" class="space-y-2 overflow-y-auto max-h-[400px] pr-1 flex-1 custom-scroll"></div>
                        </div>
                    </div>
                </div>

                <div class="lg:col-span-2 space-y-6">
                    
                    <div class="bg-white p-5 rounded-3xl border border-slate-100 shadow-soft fade-in">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-base text-slate-800 flex items-center gap-2"><span class="bg-orange-50 text-orange-600 p-1.5 rounded-lg">ğŸ“</span> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª</h3>
                            <span class="text-[10px] bg-slate-100 text-slate-500 px-2 py-0.5 rounded-md font-bold" id="finCount">0</span>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-4">
                            <div class="bg-orange-50/50 p-3 rounded-2xl border border-orange-100 group">
                                <label class="text-[10px] font-black text-orange-600 block mb-1">Ù…ØµØ±ÙˆÙ (Ø¥Ø´Ù‡Ø§Ø±..)</label>
                                <div class="flex gap-1">
                                    <input type="text" id="expDesc" class="flex-1 h-8 bg-white rounded-lg px-2 text-[10px] font-bold outline-none border border-orange-200" placeholder="Ø§Ù„ÙˆØµÙ">
                                    <input type="number" id="expAmount" class="w-14 h-8 bg-white rounded-lg px-1 text-[10px] text-center font-bold outline-none border border-orange-200" placeholder="0">
                                    <button onclick="addTransaction('expense')" class="bg-orange-500 text-white w-8 h-8 rounded-lg font-bold hover:bg-orange-600 transition">+</button>
                                </div>
                            </div>
                            <div class="bg-red-50/50 p-3 rounded-2xl border border-red-100 group">
                                <label class="text-[10px] font-black text-red-600 block mb-1">Ø¯ÙØ¹ Ù„Ù„Ù…ÙˆØ±Ø¯</label>
                                <div class="flex gap-1">
                                    <div class="flex-1 h-8 flex items-center justify-center bg-white rounded-lg border border-red-200 text-[10px] font-bold text-red-400">Ø¯ÙØ¹Ø© Ø­Ø³Ø§Ø¨</div>
                                    <input type="number" id="payAmount" class="w-14 h-8 bg-white rounded-lg px-1 text-[10px] text-center font-bold outline-none border border-red-200 text-red-600" placeholder="0">
                                    <button onclick="addTransaction('payment')" class="bg-red-500 text-white w-8 h-8 rounded-lg font-bold hover:bg-red-600 transition">+</button>
                                </div>
                            </div>
                            <div class="bg-emerald-50/50 p-3 rounded-2xl border border-emerald-100 group">
                                <label class="text-[10px] font-black text-emerald-600 block mb-1">Ø§Ø³ØªÙ„Ø§Ù… ÙƒØ§Ø´</label>
                                <div class="flex gap-1">
                                    <div class="flex-1 h-8 flex items-center justify-center bg-white rounded-lg border border-emerald-200 text-[10px] font-bold text-emerald-400">Ø§Ø³ØªÙ„Ø§Ù… Ø£Ø±Ø¨Ø§Ø­</div>
                                    <input type="number" id="incomeAmount" class="w-14 h-8 bg-white rounded-lg px-1 text-[10px] text-center font-bold outline-none border border-emerald-200 text-emerald-600" placeholder="0">
                                    <button onclick="addTransaction('income')" class="bg-emerald-500 text-white w-8 h-8 rounded-lg font-bold hover:bg-emerald-600 transition">+</button>
                                </div>
                            </div>
                        </div>
                        <div class="bg-slate-50 rounded-2xl border border-slate-200 overflow-hidden">
                            <input type="text" id="finSearch" onkeyup="renderFinancials()" class="w-full p-2 text-[10px] bg-white border-b border-slate-200 outline-none text-center font-bold text-slate-500" placeholder="Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø³Ø¬Ù„...">
                            <div class="max-h-[150px] overflow-y-auto p-2 space-y-1.5 custom-scroll" id="finList"></div>
                        </div>
                    </div>

                    <div class="bg-white p-5 rounded-3xl border border-slate-100 shadow-soft fade-in">
                        <div class="flex justify-between items-center mb-4">
                            <div>
                                <h3 class="font-bold text-base text-slate-800 flex items-center gap-2">
                                    <span class="bg-purple-50 text-purple-600 p-1.5 rounded-lg">ğŸš›</span> Ø§Ù„Ø³Ù„Ø¹ Ø§Ù„Ù…Ø±Ø³Ù„Ø© (Shipped)
                                </h3>
                                <p class="text-[9px] text-slate-400 mt-0.5 flex items-center gap-1">
                                    <span class="w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse"></span>
                                    ÙŠØªÙ… Ø¬Ù„Ø¨ Ø§Ù„Ø¹Ø¯Ø¯ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù…Ù† Ø§Ù„Ø·Ù„Ø¨Ø§Øª
                                </p>
                            </div>
                        </div>

                        <div class="hidden md:block overflow-x-auto rounded-2xl border border-slate-100">
                            <table class="w-full text-xs whitespace-nowrap text-right">
                                <thead class="bg-slate-50 text-[9px] uppercase font-bold text-slate-500">
                                    <tr>
                                        <th class="p-3">Ø§Ù„Ù…Ù†ØªØ¬</th>
                                        <th class="p-3 text-center">Ø§Ù„Ø¹Ø¯Ø¯ (Shipped)</th>
                                        <th class="p-3 text-center text-emerald-600">Ù…Ù† Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</th>
                                        <th class="p-3 text-center text-blue-600">Ø´Ø±Ø§Ø¡ Ø¬Ø¯ÙŠØ¯</th>
                                        <th class="p-3 text-center text-slate-500">ØªÙƒÙ„ÙØ© Ø§Ù„ÙˆØ­Ø¯Ø© (+Pack)</th>
                                        <th class="p-3 text-left text-red-600">Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ Ù„Ù„Ù…ÙˆØ±Ø¯</th>
                                    </tr>
                                </thead>
                                <tbody id="shippedTableBody" class="divide-y divide-slate-50"></tbody>
                            </table>
                        </div>
                        
                        <div class="md:hidden space-y-3" id="shippedMobileContainer"></div>
                    </div>

                </div>
            </div>
        </div>

        <button id="scrollTopBtn" onclick="window.scrollTo({top:0, behavior:'smooth'})" class="fixed bottom-6 left-6 z-40 p-3 bg-slate-900 text-white rounded-full shadow-xl opacity-0 translate-y-10 pointer-events-none hover:bg-orange-600 transition duration-300">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"></path></svg>
        </button>

    </div>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyt8iEy7Dc8mmWAbSKkBXUd310oz6aArHo4hFVjfXrJ7m7j9GwObtMVOJw0lt0jjMIW/exec";
        const PASS_CODE = "1129";

        let data = { products: [], financials: [], shippedStats: {} };
        let saveTimeout, autoSyncInterval;

        if(localStorage.getItem('zafir_auth') === 'true') {
            document.getElementById('loginSection').classList.add('hidden');
            document.getElementById('dashboardContent').classList.remove('hidden');
        }

        window.onload = async () => {
            if(localStorage.getItem('zafir_auth') === 'true') {
                updateStatus('loading');
                await loadCloudData(); 
                await syncWithOrders();
                autoSyncInterval = setInterval(() => { if(!document.hidden) syncWithOrders(true); }, 30000);
            }
        };

        const scrollBtn = document.getElementById('scrollTopBtn');
        window.addEventListener('scroll', () => {
            if (window.scrollY > 300) scrollBtn.classList.remove('opacity-0', 'translate-y-10', 'pointer-events-none');
            else scrollBtn.classList.add('opacity-0', 'translate-y-10', 'pointer-events-none');
        });

        function showToast(msg, type='info') {
            const c = document.getElementById('toast-container');
            const t = document.createElement('div');
            const color = type === 'success' ? 'bg-emerald-600' : (type==='error'?'bg-red-500':'bg-slate-800');
            t.className = `pointer-events-auto flex items-center gap-3 px-5 py-3 rounded-2xl text-white font-bold shadow-lg transform transition-all duration-300 translate-y-10 opacity-0 ${color}`;
            t.innerHTML = `<span class="text-lg">${type==='success'?'âœ…':(type==='error'?'âŒ':'â„¹ï¸')}</span> <span class="text-xs">${msg}</span>`;
            c.appendChild(t);
            requestAnimationFrame(() => t.classList.remove('translate-y-10', 'opacity-0'));
            setTimeout(() => { t.classList.add('translate-y-10', 'opacity-0'); setTimeout(()=>t.remove(), 300); }, 3000);
        }

        function attemptLogin() {
            if(document.getElementById('adminPass').value === PASS_CODE) {
                localStorage.setItem('zafir_auth', 'true');
                location.reload(); 
            } else { showToast("Ø§Ù„Ø±Ù…Ø² Ø®Ø§Ø·Ø¦", "error"); }
        }

        function logout() {
            if(confirm("ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ")) { localStorage.removeItem('zafir_auth'); location.reload(); }
        }

        function triggerAutoSave() {
            updateStatus('loading');
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(saveData, 1500);
        }

        function updateStatus(status) {
            const dot = document.getElementById('syncStatus');
            dot.className = `status-dot st-${status}`;
            if(status === 'saved') setTimeout(() => dot.className = 'status-dot', 2000);
        }

        async function syncWithOrders(silent = false) {
            if(!silent) updateStatus('loading');
            try {
                const res = await fetch(`${SCRIPT_URL}?action=read&t=${new Date().getTime()}`);
                const orders = await res.json();
                
                const shippedOrders = orders.filter(o => o.status === 'Shipped');
                const counts = {};
                shippedOrders.forEach(o => { 
                    const pNameClean = o.product.split('[')[0].trim();
                    counts[pNameClean] = (counts[pNameClean] || 0) + 1; 
                });
                
                let change = false;
                
                data.products.forEach(prod => {
                    const totalShippedForThisProduct = counts[prod.name] || 0;
                    const cur = totalShippedForThisProduct;
                    const prev = parseInt(prod.lastSyncedCount) || 0;
                    const diff = cur - prev;

                    if (diff > 0) {
                        let stock = parseInt(prod.stockReturn) || 0;
                        if (stock >= diff) {
                            stock -= diff;
                            prod.totalUsedStock = (parseInt(prod.totalUsedStock) || 0) + diff;
                        } else {
                            const used = stock;
                            stock = 0;
                            prod.totalUsedStock = (parseInt(prod.totalUsedStock) || 0) + used;
                        }
                        prod.stockReturn = stock;
                        prod.lastSyncedCount = cur;
                        change = true;
                    } else if (diff !== 0) {
                        prod.lastSyncedCount = cur;
                        change = true;
                    }
                });

                data.shippedStats = counts; 
                renderProducts(); renderShippedTable(); updateDashboard();
                if(change) await saveData();
                else if(!silent) updateStatus('saved');
            } catch(e) { if(!silent) updateStatus('error'); }
        }

        async function saveData() {
            const fd = new FormData(); fd.append('action', 'save_accounting'); fd.append('data', JSON.stringify(data));
            try { await fetch(SCRIPT_URL, { method: 'POST', body: fd, mode: 'no-cors' }); updateStatus('saved'); } 
            catch(e){ updateStatus('error'); }
        }

        async function loadCloudData() {
            try {
                const res = await fetch(`${SCRIPT_URL}?action=get_accounting&t=${new Date().getTime()}`);
                const cloud = await res.json();
                if(cloud && cloud.products) data = cloud;
                renderProducts(); renderFinancials(); renderShippedTable(); updateDashboard();
            } catch(e){ updateStatus('error'); }
        }

        function addProduct() {
            const name = document.getElementById('prodName').value.trim();
            const cost = parseFloat(document.getElementById('prodCost').value);
            const pack = parseFloat(document.getElementById('prodPack').value) || 0;

            if(!name || isNaN(cost)) return showToast("Ø§Ù„Ù…Ø±Ø¬Ùˆ Ù…Ù„Ø¡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª", "error");

            const ex = data.products.find(p => p.name === name);
            if(ex) {
                ex.cost = cost;
                ex.packingCost = pack;
                showToast("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù†ØªØ¬");
            } else {
                data.products.push({
                    name, cost, packingCost: pack,
                    stockReturn: 0, lastSyncedCount: 0, totalUsedStock: 0
                });
                showToast("ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø¬Ø§Ø­", "success");
            }
            document.getElementById('prodName').value = '';
            document.getElementById('prodCost').value = '';
            document.getElementById('prodPack').value = '';
            renderProducts(); renderShippedTable(); updateDashboard(); triggerAutoSave();
        }

        function modifyStock(name, delta) {
            const p = data.products.find(p => p.name === name);
            if(p) {
                let n = (parseInt(p.stockReturn) || 0) + delta;
                p.stockReturn = n < 0 ? 0 : n;
                renderProducts(); updateDashboard(); triggerAutoSave();
            }
        }

        function removeProduct(name) {
            if(confirm("Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ØŸ")) {
                data.products = data.products.filter(p => p.name !== name);
                renderProducts(); renderShippedTable(); updateDashboard(); triggerAutoSave();
            }
        }

        function renderProducts() {
            const list = document.getElementById('productsList');
            const search = document.getElementById('prodSearch').value.toLowerCase();
            list.innerHTML = '';
            
            const filtered = data.products.filter(p => p.name.toLowerCase().includes(search));
            document.getElementById('prodCount').innerText = filtered.length;

            filtered.forEach(p => {
                const s = parseInt(p.stockReturn) || 0;
                const packCost = parseFloat(p.packingCost) || 0;
                list.innerHTML += `
                    <div class="flex justify-between items-center bg-white p-3 rounded-2xl text-xs border border-slate-100 hover:border-blue-200 transition group shadow-sm">
                        <div class="flex-1 min-w-0">
                            <div class="font-bold text-slate-800 text-xs truncate" title="${p.name}">${p.name}</div>
                            <div class="flex gap-2 mt-1">
                                <span class="text-[9px] bg-slate-50 text-slate-500 px-2 py-0.5 rounded-md border border-slate-200 font-bold">ØªÙƒÙ„ÙØ©: ${p.cost}</span>
                                <span class="text-[9px] bg-orange-50 text-orange-500 px-2 py-0.5 rounded-md border border-orange-100 font-bold">ØªØºÙ„ÙŠÙ: ${packCost}</span>
                            </div>
                        </div>
                        <div class="flex items-center gap-1 bg-slate-50 border border-slate-200 rounded-xl p-1 mx-2">
                            <button onclick="modifyStock('${p.name}', -1)" class="w-6 h-6 bg-white text-slate-400 rounded-lg hover:bg-red-50 hover:text-red-500 font-bold shadow-sm transition flex items-center justify-center">-</button>
                            <span class="w-6 text-center font-black text-slate-700">${s}</span>
                            <button onclick="modifyStock('${p.name}', 1)" class="w-6 h-6 bg-white text-slate-400 rounded-lg hover:bg-emerald-50 hover:text-emerald-500 font-bold shadow-sm transition flex items-center justify-center">+</button>
                        </div>
                        <button onclick="removeProduct('${p.name}')" class="text-slate-300 hover:text-red-500 text-lg opacity-0 group-hover:opacity-100 transition px-1">&times;</button>
                    </div>`;
            });
        }

        function addTransaction(type) {
            let amountInput = document.getElementById(type==='payment'?'payAmount':(type==='income'?'incomeAmount':'expAmount'));
            let val = parseFloat(amountInput.value);
            if(!val) return showToast("Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¨Ù„Øº", "error");
            
            let desc = "";
            if(type === 'expense') desc = document.getElementById('expDesc').value || "Ù…ØµØ±ÙˆÙ";
            else if(type === 'payment') desc = "Ø¯ÙØ¹Ø© Ø­Ø³Ø§Ø¨";
            else desc = "Ø§Ø³ØªÙ„Ø§Ù… Ø£Ø±Ø¨Ø§Ø­";

            data.financials.unshift({type, amount:val, desc, date: new Date().toLocaleDateString('en-GB')});
            amountInput.value = '';
            if(type === 'expense') document.getElementById('expDesc').value = '';
            
            renderFinancials(); updateDashboard(); triggerAutoSave();
            showToast("ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„", "success");
        }

        function renderFinancials() {
            const list = document.getElementById('finList');
            const search = document.getElementById('finSearch').value.toLowerCase();
            list.innerHTML = '';
            const filtered = data.financials.filter(t => (t.desc||'').toLowerCase().includes(search) || t.date.includes(search));
            document.getElementById('finCount').innerText = filtered.length;

            filtered.forEach((t, i) => {
                let col = t.type==='income'?'text-emerald-500':(t.type==='payment'?'text-red-500':'text-orange-500');
                let bg = t.type==='income'?'bg-emerald-50':(t.type==='payment'?'bg-red-50':'bg-orange-50');
                let icon = t.type==='income'?'â†“':(t.type==='payment'?'â†‘':'â€¢');
                
                list.innerHTML += `
                    <div class="flex justify-between items-center bg-white p-2.5 rounded-xl text-xs border border-slate-100 hover:shadow-sm transition group">
                        <div class="flex items-center gap-2 flex-1 min-w-0">
                            <span class="w-6 h-6 flex items-center justify-center rounded-lg ${bg} ${col} font-black text-[10px] shrink-0">${icon}</span>
                            <div class="truncate">
                                <span class="block font-bold text-slate-700 truncate">${t.desc}</span>
                                <span class="block text-[9px] text-slate-400 font-mono">${t.date}</span>
                            </div>
                        </div>
                        <div class="flex items-center gap-2 pl-1">
                            <span class="font-black ${col}">${t.amount}</span>
                            <button onclick="data.financials.splice(${i},1);renderFinancials();updateDashboard();triggerAutoSave()" class="text-slate-300 hover:text-red-500 font-bold text-lg leading-none opacity-0 group-hover:opacity-100 transition">&times;</button>
                        </div>
                    </div>`;
            });
        }

        function renderShippedTable() {
            const body = document.getElementById('shippedTableBody');
            const mobile = document.getElementById('shippedMobileContainer');
            body.innerHTML = ''; mobile.innerHTML = '';

            data.products.forEach(p => {
                const totalShipped = data.shippedStats[p.name] || 0;

                if(totalShipped > 0) {
                    const usedStock = parseInt(p.totalUsedStock) || 0;
                    const newBuy = Math.max(0, totalShipped - usedStock);
                    const unitCost = p.cost;
                    const packCost = parseFloat(p.packingCost) || 0;
                    const totalRowDebt = (newBuy * unitCost) + (totalShipped * packCost);

                    // Desktop Row
                    body.innerHTML += `
                        <tr class="hover:bg-slate-50 transition border-b border-slate-50 last:border-0 text-[11px] font-bold text-slate-700">
                            <td class="p-3 text-right">${p.name}</td>
                            <td class="p-3 text-center">${totalShipped}</td>
                            <td class="p-3 text-center text-emerald-600">${usedStock}</td>
                            <td class="p-3 text-center text-blue-600">${newBuy}</td>
                            <td class="p-3 text-center text-slate-400">${unitCost} + ${packCost}</td>
                            <td class="p-3 text-left font-black text-red-500">${totalRowDebt} DH</td>
                        </tr>`;

                    // IMPROVED MOBILE CARD (GRID LAYOUT)
                    mobile.innerHTML += `
                        <div class="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm relative overflow-hidden mb-3">
                            <div class="absolute right-0 top-0 bottom-0 w-1.5 bg-slate-800"></div>
                            
                            <div class="pr-3 mb-3 border-b border-slate-50 pb-2">
                                <div class="font-bold text-slate-800 text-sm">${p.name}</div>
                            </div>

                            <div class="grid grid-cols-3 gap-2 pr-3 mb-3 text-center">
                                <div class="bg-slate-50 p-2 rounded-lg border border-slate-100">
                                    <span class="block text-[9px] text-slate-400 font-bold mb-1">Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„ÙƒÙ„ÙŠ</span>
                                    <span class="block text-xs font-black text-slate-800">${totalShipped}</span>
                                </div>
                                <div class="bg-emerald-50 p-2 rounded-lg border border-emerald-100">
                                    <span class="block text-[9px] text-emerald-600 font-bold mb-1">Ù…Ù† Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</span>
                                    <span class="block text-xs font-black text-emerald-600">${usedStock}</span>
                                </div>
                                <div class="bg-blue-50 p-2 rounded-lg border border-blue-100">
                                    <span class="block text-[9px] text-blue-600 font-bold mb-1">Ø´Ø±Ø§Ø¡ Ø¬Ø¯ÙŠØ¯</span>
                                    <span class="block text-xs font-black text-blue-600">${newBuy}</span>
                                </div>
                            </div>

                            <div class="flex justify-between items-center pr-3 bg-slate-50 p-2 rounded-lg">
                                <div class="text-[10px] text-slate-500 font-bold">
                                    Ø§Ù„ØªÙƒÙ„ÙØ© (${unitCost} + ${packCost})
                                </div>
                                <div class="text-left">
                                    <span class="block text-[9px] text-red-400 font-bold">Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ Ù„Ù„Ù…ÙˆØ±Ø¯</span>
                                    <span class="font-black text-red-500 text-base">${totalRowDebt} DH</span>
                                </div>
                            </div>
                        </div>`;
                }
            });
        }

        function updateDashboard() {
            let totalDebt = 0;
            data.products.forEach(p => {
                const totalShipped = data.shippedStats[p.name] || 0;
                const usedStock = parseInt(p.totalUsedStock) || 0;
                const newBuy = Math.max(0, totalShipped - usedStock);
                const packCost = parseFloat(p.packingCost) || 0;
                totalDebt += (newBuy * p.cost) + (totalShipped * packCost);
            });

            let paid = 0, exp = 0, inc = 0;
            data.financials.forEach(t => { 
                if(t.type === 'payment') paid += t.amount; 
                else if(t.type === 'expense') exp += t.amount; 
                else inc += t.amount; 
            });

            const supplierDebt = totalDebt - paid;
            const netProfit = inc - exp - totalDebt;

            document.getElementById('supplierDebt').innerText = supplierDebt.toLocaleString();
            document.getElementById('totalExpenses').innerText = exp.toLocaleString(); 
            document.getElementById('totalRevenue').innerText = inc.toLocaleString();
            
            const profEl = document.getElementById('netProfit');
            profEl.innerText = netProfit.toLocaleString();
            profEl.className = netProfit >= 0 ? "text-2xl font-black text-emerald-400 z-10" : "text-2xl font-black text-red-400 z-10";
        }
    </script>
</body>
</html>
